name: CI/CD for LoginApi to Windows EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy-loginapi-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Build and Publish Artifact
        shell: pwsh
        run: |
          dotnet restore LoginApi.csproj
          dotnet publish LoginApi.csproj -c Release -o ./publish

      - name: Upload publish directory as artifact
        uses: actions/upload-artifact@v4
        with:
          name: loginapi-publish
          path: ./publish
          retention-days: 1

      - name: Install Posh-SSH Module
        shell: pwsh
        run: |
          Install-Module -Name Posh-SSH -Force -Scope CurrentUser

      - name: Deploy and Restart Application via Posh-SSH (Password Auth)
        shell: pwsh
        run: |
          $remoteHost = "${{ vars.EC2_HOST_WINDOWS }}"
          $username = "Administrator"
          $password = "${{ secrets.EC2_ADMIN_PASSWORD }}"
          $deployPath = "C:\inetpub\wwwroot\LoginApi"
          $appPool = "LoginApiAppPool"

          $GhToken = "${{ secrets.GITHUB_TOKEN }}"
          $RepoOwner = "${{ github.repository_owner }}"
          $RepoName = "${{ github.event.repository.name }}"
          $RunId = "${{ github.run_id }}"
          $ArtifactName = "loginapi-publish"

          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential($username, $securePassword)

          Write-Host "Establishing SSH session..."
          $session = New-SSHSession -HostName $remoteHost -Credential $credential -AcceptKey -ErrorAction Stop

          $finalCommand = @"
          `$DeployPath = '$deployPath'
          `$AppPool = '$appPool'
          `$GhToken = '$GhToken'
          `$RepoOwner = '$RepoOwner'
          `$RepoName = '$RepoName'
          `$RunId = '$RunId'
          `$ArtifactName = '$ArtifactName'

          `$TEMP_ZIP = 'C:\Users\Administrator\temp_artifact.zip'
          `$URL = "https://api.github.com/repos/$RepoOwner/$RepoName/actions/runs/$RunId/artifacts"

          `$HEADERS = @{
              "Authorization" = "token `$GhToken";
              "Accept" = "application/vnd.github.v3+json";
          }

          `$RESPONSE = Invoke-RestMethod -Uri `$URL -Headers `$HEADERS
          `$ARTIFACT = `$RESPONSE.artifacts | Where-Object { `$_.name -eq `$ArtifactName }

          if (-not `$ARTIFACT) { throw "Artifact `$ArtifactName not found in the run." }

          `$DOWNLOAD_URL = `$ARTIFACT.archive_download_url

          Write-Host "Downloading artifact from GitHub API..."
          Invoke-WebRequest -Uri `$DOWNLOAD_URL -Headers `$HEADERS -OutFile `$TEMP_ZIP
          Write-Host "Download complete."

          if (-not (Test-Path -Path `$DeployPath)) { New-Item -ItemType Directory -Path `$DeployPath -Force }

          Write-Host "Extracting files..."
          Expand-Archive -Path `$TEMP_ZIP -DestinationPath `$DeployPath -Force
          Remove-Item -Path `$TEMP_ZIP

          Import-Module WebAdministration
          Restart-WebAppPool -Name `$AppPool -Force
          Write-Host "Deployment successful and App Pool `$AppPool restarted."
          "@

          Invoke-SSHCommand -SshSession $session -Command $finalCommand
          Remove-SSHSession -SshSession $session
